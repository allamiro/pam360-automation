---
- name: Check if user {{ current_user.key }} exists locally
  ansible.builtin.getent:
    database: passwd
    key: "{{ current_user.key }}"
  register: user_exists
  failed_when: false

- name: Create local user {{ current_user.key }} (does not exist)
  ansible.builtin.user:
    name: "{{ current_user.key }}"
    password: "{{ current_user.value | password_hash('sha512') }}"
    create_home: yes
    shell: /bin/bash
    state: present
  become: yes
  no_log: true
  register: user_create_result
  when:
    - user_exists is failed
    - pam_create_local_accounts | default(false)

- name: Debug local account creation
  debug:
    msg: "Created local user '{{ current_user.key }}': {{ 'Success' if user_create_result is succeeded else 'Failed' }}"
  when:
    - user_exists is failed
    - pam_create_local_accounts | default(false)

- name: Track local account creation
  set_fact:
    user_status: "{{ user_status | combine({current_user.key: user_status.get(current_user.key, {}) | combine({'created_local': true})}) }}"
  when:
    - user_exists is failed
    - pam_create_local_accounts | default(false)
    - user_create_result is succeeded

- name: Update password for user {{ current_user.key }} on remote host
  ansible.builtin.user:
    name: "{{ current_user.key }}"
    password: "{{ current_user.value | password_hash('sha512') }}"
    update_password: always
  become: yes
  no_log: true
  register: password_change_result
  when: user_exists is succeeded or (user_create_result is defined and user_create_result is succeeded)

- name: Track Linux password rotation success
  set_fact:
    user_status: "{{ user_status | combine({current_user.key: user_status.get(current_user.key, {}) | combine({'rotated_linux': true})}) }}"
  when: (user_exists is succeeded or (user_create_result is defined and user_create_result is succeeded)) and password_change_result is succeeded

- name: Track skipped user (missing locally, creation disabled)
  set_fact:
    user_status: "{{ user_status | combine({current_user.key: user_status.get(current_user.key, {}) | combine({'skipped_missing_local': true})}) }}"
  when:
    - user_exists is failed
    - not (pam_create_local_accounts | default(false))
