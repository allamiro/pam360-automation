---
- name: Check if user {{ current_user.key }} exists locally
  ansible.builtin.getent:
    database: passwd
    key: "{{ current_user.key }}"
  register: user_exists
  ignore_errors: true

- name: Update password for user {{ current_user.key }} on remote host
  ansible.builtin.user:
    name: "{{ current_user.key }}"
    password: "{{ current_user.value | password_hash('sha512') }}"
    update_password: always
  become: yes
  no_log: true
  register: password_change_result
  when: user_exists is succeeded

- name: Track Linux password rotation success
  set_fact:
    user_status: "{{ user_status | combine({current_user.key: user_status.get(current_user.key, {}) | combine({'rotated_linux': true})}) }}"
  when: user_exists is succeeded and password_change_result is succeeded

- name: Track skipped user (missing locally)
  set_fact:
    user_status: "{{ user_status | combine({current_user.key: user_status.get(current_user.key, {}) | combine({'skipped_missing_local': true})}) }}"
  when: user_exists is failed
