---
# =======================================================
# 0. Initialize Status Tracking
# =======================================================
- name: Initialize user status tracking
  set_fact:
    user_status: {}

# =======================================================
# 1. Generate Passwords for Target Users
# =======================================================
- name: Generate cleartext passwords for target users
  set_fact:
    user_pass_map: "{{ user_pass_map | default({}) | combine({ item: (lookup('password', '/dev/null length=1 chars=ascii_letters') ~ lookup('password', '/dev/null length=10 chars=ascii_letters,digits') ~ lookup('password', '/dev/null length=1 chars=.,!@#$%') ~ lookup('password', '/dev/null length=2 chars=digits')) }) }}"
  loop: "{{ pam_target_users }}"
  no_log: true

# =======================================================
# 2. Check Resource Existence (API 1.1)
# =======================================================
- name: Fetch all resources from PAM360 to check existence
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
    return_content: yes
  register: all_resources_response
  delegate_to: localhost
  become: false

- name: Initialize resource tracking
  set_fact:
    pam_resource_id: ""
    resource_was_created: false

- name: Find Resource ID for current hostname
  set_fact:
    pam_resource_id: "{{ item['RESOURCE ID'] }}"
  loop: "{{ all_resources_response.json.operation.Details | default([]) }}"
  when: item['RESOURCE NAME'] == ansible_facts.hostname
  no_log: true

- name: Debug resource check
  debug:
    msg: "Resource ID: {{ pam_resource_id if pam_resource_id | length > 0 else 'NOT FOUND - will create' }}"

# =======================================================
# 3. Logic Branch A: Resource Exists - Update Accounts
# =======================================================
- name: RESOURCE EXISTS - Process Accounts
  block:
    - name: Fetch existing accounts for the resource (API 2.1)
      uri:
        url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/accounts"
        method: GET
        headers:
          AUTHTOKEN: "{{ pam_token }}"
        validate_certs: "{{ pam_validate_certs }}"
      register: existing_accounts_response
      delegate_to: localhost
      become: false

    - name: Build existing accounts list
      set_fact:
        existing_accounts_list: "{{ existing_accounts_response.json.operation.Details['ACCOUNT LIST'] | default([]) }}"

    - name: Loop through users to Update or Create Accounts
      include_tasks: process_user.yml
      loop: "{{ user_pass_map | dict2items }}"
      loop_control:
        loop_var: current_user

  when: pam_resource_id | length > 0

# =======================================================
# 4. Logic Branch B: Resource Does Not Exist - Create It
# =======================================================
- name: Set first user for resource creation
  set_fact:
    first_user: "{{ pam_target_users | first }}"
    first_pass: "{{ user_pass_map[pam_target_users | first] }}"
    remaining_users: "{{ pam_target_users[1:] }}"
  when: pam_resource_id | length == 0

- name: Create New Resource in PAM360 (API 1.2)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources"
    method: POST
    headers:
      AUTHTOKEN: "{{ pam_token }}"
      Content-Type: "text/json"
    validate_certs: "{{ pam_validate_certs }}"
    body: 'INPUT_DATA={"operation":{"Details":{"RESOURCENAME":"{{ ansible_facts.hostname }}","ACCOUNTNAME":"{{ first_user }}","RESOURCETYPE":"Linux","PASSWORD":"{{ first_pass }}","DNSNAME":"{{ ansible_facts.default_ipv4.address }}","RESOURCEPASSWORDPOLICY":"Strong","ACCOUNTPASSWORDPOLICY":"Strong","RESOURCEGROUPNAME":"{{ pam_resource_group_name }}"}}}'
  register: create_resource_response
  delegate_to: localhost
  become: false
  no_log: true
  when: pam_resource_id | length == 0

- name: Debug resource creation
  debug:
    msg: "Resource creation: {{ create_resource_response.json.operation.result.message | default('Skipped') }}"
  when: create_resource_response is defined and create_resource_response.json is defined

- name: Fetch ID of newly created resource (API 1.3)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/resourcename/{{ ansible_facts.hostname }}"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
  register: new_resource_data
  delegate_to: localhost
  become: false
  when: pam_resource_id | length == 0

- name: Set new Resource ID and flag
  set_fact:
    pam_resource_id: "{{ new_resource_data.json.operation.Details['RESOURCEID'] }}"
    resource_was_created: true
  when: new_resource_data is defined and new_resource_data.json is defined

- name: Debug new resource ID
  debug:
    msg: "New Resource ID: {{ pam_resource_id }}"
  when: resource_was_created | default(false)

# =======================================================
# 5. Create Remaining Accounts (API 2.4) - After Resource Creation
# =======================================================
- name: Debug remaining users to add
  debug:
    msg: "Remaining users to add: {{ remaining_users | default([]) }}"
  when: resource_was_created | default(false)

- name: Create remaining accounts (API 2.4)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/accounts"
    method: POST
    headers:
      AUTHTOKEN: "{{ pam_token }}"
      Content-Type: "text/json"
    validate_certs: "{{ pam_validate_certs }}"
    body: 'INPUT_DATA={"operation":{"Details":{"ACCOUNTLIST":[{"ACCOUNTNAME":"{{ item }}","PASSWORD":"{{ user_pass_map[item] }}","ACCOUNTPASSWORDPOLICY":"Strong"}]}}}'
  loop: "{{ remaining_users | default([]) }}"
  delegate_to: localhost
  become: false
  no_log: true
  register: create_accounts_result
  when:
    - resource_was_created | default(false)
    - remaining_users | default([]) | length > 0

- name: Debug account creation result
  debug:
    msg: "Created account: {{ item.item }} - {{ item.json.operation.result.message | default('Unknown') }}"
  loop: "{{ create_accounts_result.results | default([]) }}"
  when:
    - create_accounts_result is defined
    - create_accounts_result.results is defined
    - item.json is defined
  no_log: false

# =======================================================
# 5. Share Resource (API 9.1)
# =======================================================
- name: Share Resource with User
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/share"
    method: PUT
    headers:
      AUTHTOKEN: "{{ pam_token }}"
      Content-Type: "text/json"
    validate_certs: "{{ pam_validate_certs }}"
    body: 'INPUT_DATA={"operation":{"Details":{"ACCESSTYPE":"fullaccess","USERID":"{{ pam_share_user_id }}"}}}'
  register: share_response
  delegate_to: localhost
  become: false
  when: pam_resource_id is defined

- name: Debug share result
  debug:
    msg: "Share result: {{ share_response.json.operation.result.message | default('Skipped') }}"
  when: share_response is defined

# =======================================================
# 5b. Share Accounts with User (API 9.5)
# =======================================================
- name: Get account IDs for sharing
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/accounts"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
  register: accounts_for_sharing
  delegate_to: localhost
  become: false
  when: pam_resource_id is defined

- name: Share each account with user (API 9.5)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/accounts/{{ item['ACCOUNT ID'] }}/share"
    method: PUT
    headers:
      AUTHTOKEN: "{{ pam_token }}"
      Content-Type: "text/json"
    validate_certs: "{{ pam_validate_certs }}"
    body: 'INPUT_DATA={"operation":{"Details":{"ACCESSTYPE":"modify","USERID":"{{ pam_share_user_id }}"}}}'
    status_code: [200, 201, 400, 401, 403, 404, 500]
  loop: "{{ accounts_for_sharing.json.operation.Details['ACCOUNT LIST'] | default([]) }}"
  register: share_accounts_response
  delegate_to: localhost
  become: false
  when:
    - pam_resource_id is defined
    - accounts_for_sharing is defined
    - accounts_for_sharing.json is defined

- name: Debug account share results
  debug:
    msg: "Shared account '{{ item.item['ACCOUNT NAME'] }}': {{ item.json.operation.result.message | default('Unknown') }}"
  loop: "{{ share_accounts_response.results | default([]) }}"
  when:
    - share_accounts_response is defined
    - share_accounts_response.results is defined
    - item.json is defined

# =======================================================
# 6. Associate Resource to Resource Group (API 6.2)
# =======================================================
- name: Get all Resource Groups (API 6.7)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resourcegroup"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
  register: all_resource_groups
  delegate_to: localhost
  become: false
  when: pam_resource_id is defined

- name: Find Resource Group ID by name
  set_fact:
    pam_resource_group_id: "{{ item.resourceGroupId }}"
  loop: "{{ all_resource_groups.json.operation.Details | default([]) }}"
  when:
    - all_resource_groups is defined
    - all_resource_groups.json is defined
    - item.resourceGroupName == pam_resource_group_name
  no_log: true

- name: Debug resource group ID
  debug:
    msg: "Resource Group '{{ pam_resource_group_name }}' ID: {{ pam_resource_group_id | default('NOT FOUND') }}"

- name: Check if resource is already in group (API 6.4)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/associatedGroups"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
  register: associated_groups
  delegate_to: localhost
  become: false
  when:
    - pam_resource_id is defined
    - pam_resource_group_id is defined

- name: Check if already in target group
  set_fact:
    already_in_group: "{{ pam_resource_group_id in (associated_groups.json.operation.Details['ASSOCIATED GROUPS'] | default([]) | map(attribute='GROUP ID') | map('string') | list) }}"
  when: associated_groups is defined and associated_groups.json is defined

- name: Debug current group associations
  debug:
    msg: "Resource already in '{{ pam_resource_group_name }}': {{ already_in_group | default(false) }}"

- name: Associate Resource to Resource Group (API 6.2)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resourcegroup/{{ pam_resource_group_id }}/associateResources"
    method: POST
    headers:
      AUTHTOKEN: "{{ pam_token }}"
      Content-Type: "text/json"
    validate_certs: "{{ pam_validate_certs }}"
    body: 'INPUT_DATA={"operation":{"Details":{"RESOURCEIDS":[{{ pam_resource_id }}]}}}'
  register: associate_response
  delegate_to: localhost
  become: false
  when:
    - pam_resource_id is defined
    - pam_resource_group_id is defined
    - pam_resource_group_id | length > 0
    - not (already_in_group | default(false))

- name: Debug association result
  debug:
    msg: "Association result: {{ associate_response.json.operation.result.message | default('Skipped') }}"
  when: associate_response is defined and associate_response.json is defined

# =======================================================
# 7. Update Remote Host Passwords (AFTER PAM360 sync)
# =======================================================
- name: Update Remote Linux Users with new passwords
  include_tasks: update_passwords.yml
  loop: "{{ user_pass_map | dict2items }}"
  loop_control:
    loop_var: current_user

# =======================================================
# 8. Generate KeePass-Compatible Password Record
# =======================================================
- name: Set timestamp for password file
  set_fact:
    password_file_timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
  delegate_to: localhost
  run_once: true

- name: Create password record directory
  file:
    path: "{{ playbook_dir }}/password_records"
    state: directory
    mode: '0700'
  delegate_to: localhost
  become: false
  run_once: true

- name: Generate KeePass CSV header (once per run)
  copy:
    content: |
      "Group","Title","Username","Password","URL","Notes"
    dest: "{{ playbook_dir }}/password_records/passwords_{{ password_file_timestamp }}.csv"
    mode: '0600'
  delegate_to: localhost
  become: false
  run_once: true

- name: Append password records to CSV
  lineinfile:
    path: "{{ playbook_dir }}/password_records/passwords_{{ password_file_timestamp }}.csv"
    line: '"{{ pam_resource_group_name }}","{{ ansible_facts.hostname }} - {{ item.key }}","{{ item.key }}","{{ item.value }}","ssh://{{ ansible_facts.default_ipv4.address }}","Rotated: {{ ansible_date_time.iso8601 }} | Resource ID: {{ pam_resource_id }}"'
    insertafter: EOF
  loop: "{{ user_pass_map | dict2items }}"
  delegate_to: localhost
  become: false
  no_log: true

- name: Display password file location
  debug:
    msg: "Password record saved to: {{ playbook_dir }}/password_records/passwords_{{ password_file_timestamp }}.csv"
  run_once: true

# =======================================================
# 9. Fetch Final Account List from PAM360 (API 2.1)
# =======================================================
- name: Get final account list from PAM360 (API 2.1)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/accounts"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
  register: final_accounts
  delegate_to: localhost
  become: false
  when: pam_resource_id is defined

- name: Get individual account details (API 2.2)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/accounts/{{ item['ACCOUNT ID'] }}"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
  loop: "{{ final_accounts.json.operation.Details['ACCOUNT LIST'] | default([]) }}"
  register: account_details
  delegate_to: localhost
  become: false
  when: final_accounts is defined and final_accounts.json is defined

# =======================================================
# 10. Print Summary Report
# =======================================================
- name: Print execution summary
  debug:
    msg: |
      ============================================
      PAM360 SYNC SUMMARY - {{ ansible_facts.hostname }}
      ============================================
      Resource ID: {{ pam_resource_id }}
      Resource Group: {{ pam_resource_group_name }} (ID: {{ pam_resource_group_id | default('N/A') }})
      
      LOCAL STATUS:
      {% for user, status in user_status.items() %}
        {{ user }}: PAM360={{ 'CREATED' if status.created_in_pam | default(false) else ('UPDATED' if status.updated_pam | default(false) else ('FAILED' if status.api_failed | default(false) else 'NO CHANGE')) }}, Linux={{ 'ROTATED' if status.rotated_linux | default(false) else ('SKIPPED' if status.skipped_missing_local | default(false) else 'NO CHANGE') }}
      {% endfor %}
      
      PAM360 ACCOUNTS (confirmed from API 2.1 & 2.2):
      {% for acc in final_accounts.json.operation.Details['ACCOUNT LIST'] | default([]) %}
        - {{ acc['ACCOUNT NAME'] }} (ID: {{ acc['ACCOUNT ID'] }}, Policy: {{ acc['ACCOUNT PASSWORD POLICY'] }})
      {% endfor %}
      
      ACCOUNT DETAILS:
      {% for result in account_details.results | default([]) %}
      {% if result.json is defined and result.json.operation is defined %}
        {{ result.item['ACCOUNT NAME'] }}:
          Last Modified: {{ result.json.operation.Details['LAST MODIFIED TIME'] | default('N/A') }}
          Last Accessed: {{ result.json.operation.Details['LAST ACCESSED TIME'] | default('N/A') }}
      {% endif %}
      {% endfor %}
      ============================================
