---
# =======================================================
# 0. Initialize Status Tracking and System Info
# =======================================================
- name: Initialize user status tracking
  set_fact:
    user_status: {}

- name: Get hostname from command
  command: hostname
  register: hostname_cmd
  changed_when: false

- name: Get IP addresses from command
  command: hostname -I
  register: ip_cmd
  changed_when: false
  failed_when: false

- name: Set system info variables
  set_fact:
    system_hostname: "{{ hostname_cmd.stdout | trim }}"
    system_ip: "{{ (ip_cmd.stdout | trim).split() | first | default('127.0.0.1') }}"

- name: Debug system info
  debug:
    msg: "System: {{ system_hostname }} ({{ system_ip }})"

# =======================================================
# 1. Lookup PAM360 User Group IDs from Names (API 5.1)
# =======================================================
- name: Initialize share groups list
  set_fact:
    pam_share_groups: []

- name: Get PAM360 user group IDs from names (API 5.1)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/user/getUserGroupId?USERGROUPNAME={{ item | urlencode }}"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
  register: share_group_lookups
  retries: 3
  delay: 2
  until: share_group_lookups.status in [200, 404] or share_group_lookups.json.operation.result.status is defined
  delegate_to: localhost
  become: false
  loop: "{{ pam_share_group_names | default([]) }}"
  when: pam_share_group_names is defined and pam_share_group_names | length > 0

- name: Debug raw group lookup responses
  debug:
    msg: |
      Group: {{ item.item }}
      Status: {{ item.json.operation.result.status | default('N/A') }}
      Message: {{ item.json.operation.result.message | default('N/A') }}
      GroupID: {{ item.json.operation.Details.USERGROUPID | default('NOT FOUND') }}
  loop: "{{ share_group_lookups.results | default([]) }}"
  when: share_group_lookups.results is defined

- name: Build share groups list with IDs
  set_fact:
    pam_share_groups: "{{ pam_share_groups + [{'name': item.item, 'id': item.json.operation.Details.USERGROUPID | string}] }}"
  loop: "{{ share_group_lookups.results | default([]) }}"
  when:
    - item.json is defined
    - item.json.operation.result.status == 'Success'

- name: Debug share groups lookup
  debug:
    msg: |
      Share groups configured: {{ pam_share_group_names | default([]) }}
      Share groups resolved: {{ pam_share_groups | length }} groups
      Names: {{ pam_share_groups | map(attribute='name') | list }}
      IDs: {{ pam_share_groups | map(attribute='id') | list }}

# =======================================================
# 2. Generate Passwords for Target Users
# =======================================================
- name: Generate cleartext passwords for target users
  set_fact:
    user_pass_map: "{{ user_pass_map | default({}) | combine({ item: (lookup('password', '/dev/null length=1 chars=ascii_letters') ~ lookup('password', '/dev/null length=10 chars=ascii_letters,digits') ~ lookup('password', '/dev/null length=1 chars=.,!@#$') ~ lookup('password', '/dev/null length=2 chars=digits')) }) }}"
  loop: "{{ pam_target_users }}"
  no_log: true

# =======================================================
# 3. Check Resource Existence (API 1.1)
# =======================================================
- name: Fetch all resources from PAM360 to check existence
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
    return_content: yes
  register: all_resources_response
  retries: 3
  delay: 2
  until: all_resources_response.status == 200
  failed_when: all_resources_response.json.operation.result.status | default('') == 'Failed'
  delegate_to: localhost
  become: false

- name: Initialize resource tracking
  set_fact:
    pam_resource_id: ""
    resource_was_created: false

- name: Debug all resources from PAM360
  debug:
    msg: |
      Searching for hostname: '{{ system_hostname }}'
      Total resources in PAM360: {{ all_resources_response.json.operation.Details | default([]) | length }}
      Resource names in PAM360: {{ all_resources_response.json.operation.Details | default([]) | map(attribute='RESOURCE NAME') | list }}

- name: Find Resource ID for current hostname
  set_fact:
    pam_resource_id: "{{ item['RESOURCE ID'] }}"
  loop: "{{ all_resources_response.json.operation.Details | default([]) }}"
  when: item['RESOURCE NAME'] == system_hostname
  no_log: true

- name: Debug resource check
  debug:
    msg: |
      Hostname: '{{ system_hostname }}'
      Resource ID: {{ pam_resource_id if pam_resource_id | length > 0 else 'NOT FOUND - will create' }}
      Match found: {{ 'YES' if pam_resource_id | length > 0 else 'NO' }}

# =======================================================
# 3. Logic Branch A: Resource Exists - Update Accounts
# =======================================================
- name: RESOURCE EXISTS - Process Accounts
  block:
    - name: Fetch existing accounts for the resource (API 2.1)
      uri:
        url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/accounts"
        method: GET
        headers:
          AUTHTOKEN: "{{ pam_token }}"
        validate_certs: "{{ pam_validate_certs }}"
      register: existing_accounts_response
      retries: 3
      delay: 2
      until: existing_accounts_response.status == 200
      failed_when: existing_accounts_response.json.operation.result.status | default('') == 'Failed'
      delegate_to: localhost
      become: false

    - name: Build existing accounts list
      set_fact:
        existing_accounts_list: "{{ existing_accounts_response.json.operation.Details['ACCOUNT LIST'] | default([]) }}"

    - name: Loop through users to Update or Create Accounts
      include_tasks: process_user.yml
      loop: "{{ user_pass_map | dict2items }}"
      loop_control:
        loop_var: current_user

  when: pam_resource_id | length > 0

# =======================================================
# 4. Logic Branch B: Resource Does Not Exist - Create It
# =======================================================
- name: Set first user for resource creation
  set_fact:
    first_user: "{{ pam_target_users | first }}"
    first_pass: "{{ user_pass_map[pam_target_users | first] }}"
    remaining_users: "{{ pam_target_users[1:] }}"
  when: pam_resource_id | length == 0

- name: Create New Resource in PAM360 (API 1.2)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources"
    method: POST
    headers:
      AUTHTOKEN: "{{ pam_token }}"
      Content-Type: "text/json"
    validate_certs: "{{ pam_validate_certs }}"
    body: 'INPUT_DATA={"operation":{"Details":{"RESOURCENAME":"{{ system_hostname }}","ACCOUNTNAME":"{{ first_user }}","RESOURCETYPE":"Linux","PASSWORD":"{{ first_pass }}","DNSNAME":"{{ system_ip }}","RESOURCEPASSWORDPOLICY":"Strong","ACCOUNTPASSWORDPOLICY":"Strong","RESOURCEGROUPNAME":"{{ pam_resource_group_name }}"}}}'
  register: create_resource_response
  retries: 3
  delay: 2
  until: create_resource_response.status in [200, 201]
  failed_when: create_resource_response.json.operation.result.status | default('') == 'Failed'
  delegate_to: localhost
  become: false
  no_log: true
  when: pam_resource_id | length == 0

- name: Debug resource creation
  debug:
    msg: "Resource creation: {{ create_resource_response.json.operation.result.message | default('Skipped') }}"
  when: create_resource_response is defined and create_resource_response.json is defined

- name: Fetch ID of newly created resource (API 1.3)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/resourcename/{{ system_hostname }}"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
  register: new_resource_data
  retries: 3
  delay: 2
  until: new_resource_data.status == 200
  failed_when: new_resource_data.json.operation.result.status | default('') == 'Failed'
  delegate_to: localhost
  become: false
  when: pam_resource_id | length == 0

- name: Set new Resource ID and flag
  set_fact:
    pam_resource_id: "{{ new_resource_data.json.operation.Details['RESOURCEID'] }}"
    resource_was_created: true
  when: new_resource_data is defined and new_resource_data.json is defined

- name: Debug new resource ID
  debug:
    msg: "New Resource ID: {{ pam_resource_id }}"
  when: resource_was_created | default(false)

# =======================================================
# 5. Create Remaining Accounts (API 2.4) - After Resource Creation
# =======================================================
- name: Debug remaining users to add
  debug:
    msg: "Remaining users to add: {{ remaining_users | default([]) }}"
  when: resource_was_created | default(false)

- name: Create remaining accounts (API 2.4)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/accounts"
    method: POST
    headers:
      AUTHTOKEN: "{{ pam_token }}"
      Content-Type: "text/json"
    validate_certs: "{{ pam_validate_certs }}"
    body: 'INPUT_DATA={"operation":{"Details":{"ACCOUNTLIST":[{"ACCOUNTNAME":"{{ item }}","PASSWORD":"{{ user_pass_map[item] }}","ACCOUNTPASSWORDPOLICY":"Strong"}]}}}'
  loop: "{{ remaining_users | default([]) }}"
  retries: 3
  delay: 2
  until: create_accounts_result.status in [200, 201]
  failed_when: create_accounts_result.json.operation.result.status | default('') == 'Failed'
  delegate_to: localhost
  become: false
  no_log: true
  register: create_accounts_result
  when:
    - resource_was_created | default(false)
    - remaining_users | default([]) | length > 0

- name: Debug account creation result
  debug:
    msg: "Created account: {{ item.item }} - {{ item.json.operation.result.message | default('Unknown') }}"
  loop: "{{ create_accounts_result.results | default([]) }}"
  when:
    - create_accounts_result is defined
    - create_accounts_result.results is defined
    - item.json is defined
  no_log: false

# =======================================================
# 5. Share Resource with User Groups (API 9.3)
# =======================================================
- name: Debug sharing prerequisites
  debug:
    msg: |
      === SHARING PREREQUISITES ===
      Resource ID: {{ pam_resource_id | default('NOT SET') }}
      Share groups count: {{ pam_share_groups | length }}
      Share groups: {{ pam_share_groups | default([]) }}
      Will share: {{ 'YES' if (pam_resource_id | default('') | length > 0 and pam_share_groups | length > 0) else 'NO - missing prerequisites' }}

- name: Get account IDs for sharing
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/accounts"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
  register: accounts_for_sharing
  retries: 3
  delay: 2
  until: accounts_for_sharing.status == 200
  failed_when: accounts_for_sharing.json.operation.result.status | default('') == 'Failed'
  delegate_to: localhost
  become: false
  when: pam_resource_id is defined

- name: Debug accounts for sharing
  debug:
    msg: |
      Accounts available for sharing:
      {{ accounts_for_sharing.json.operation.Details['ACCOUNT LIST'] | default([]) | map(attribute='ACCOUNT NAME') | list }}
  when: accounts_for_sharing is defined and accounts_for_sharing.json is defined
- name: Share Resource with User Groups (API 9.3)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/share"
    method: PUT
    headers:
      AUTHTOKEN: "{{ pam_token }}"
      Content-Type: "text/json"
    validate_certs: "{{ pam_validate_certs }}"
    body: 'INPUT_DATA={"operation":{"Details":{"ACCESSTYPE":"fullaccess","USERGROUPID":"{{ item.id }}"}}}'
  loop: "{{ pam_share_groups | default([]) }}"
  register: share_group_responses
  retries: 3
  delay: 2
  until: share_group_responses.status in [200, 201] or share_group_responses.json.operation.result.status is defined
  failed_when: share_group_responses.json.operation.result.status | default('') == 'Failed'
  delegate_to: localhost
  become: false
  when:
    - pam_resource_id is defined
    - pam_share_groups | length > 0

- name: Debug group share results
  debug:
    msg: "Shared resource with group '{{ item.item.name }}': {{ item.json.operation.result.message | default('Skipped') }}"
  loop: "{{ share_group_responses.results | default([]) }}"
  when:
    - share_group_responses is defined
    - item.json is defined

# =======================================================
# 5d. Share Accounts with User Groups (API 9.7)
# =======================================================
- name: Build account-group share combinations
  set_fact:
    account_group_shares: "{{ account_group_shares | default([]) + [{'account_id': item.0['ACCOUNT ID'], 'account_name': item.0['ACCOUNT NAME'], 'group_id': item.1.id, 'group_name': item.1.name}] }}"
  loop: "{{ accounts_for_sharing.json.operation.Details['ACCOUNT LIST'] | default([]) | product(pam_share_groups | default([])) | list }}"
  when:
    - accounts_for_sharing is defined
    - accounts_for_sharing.json is defined
    - pam_share_groups | length > 0
  no_log: true

- name: Share each account with each user group (API 9.7)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/accounts/{{ item.account_id }}/share"
    method: PUT
    headers:
      AUTHTOKEN: "{{ pam_token }}"
      Content-Type: "text/json"
    validate_certs: "{{ pam_validate_certs }}"
    body: 'INPUT_DATA={"operation":{"Details":{"ACCESSTYPE":"modify","USERGROUPID":"{{ item.group_id }}"}}}'
  loop: "{{ account_group_shares | default([]) }}"
  register: share_accounts_group_response
  retries: 3
  delay: 2
  until: share_accounts_group_response.status in [200, 201] or share_accounts_group_response.json.operation.result.status is defined
  failed_when: share_accounts_group_response.json.operation.result.status | default('') == 'Failed'
  delegate_to: localhost
  become: false
  when:
    - pam_resource_id is defined
    - account_group_shares is defined

- name: Debug account group share results
  debug:
    msg: "Shared account '{{ item.item.account_name }}' with group '{{ item.item.group_name }}': {{ item.json.operation.result.message | default('Unknown') }}"
  loop: "{{ share_accounts_group_response.results | default([]) }}"
  when:
    - share_accounts_group_response is defined
    - share_accounts_group_response.results is defined
    - item.json is defined

# =======================================================
# 6. Associate Resource to Resource Group (API 6.2)
# =======================================================
- name: Get all Resource Groups (API 6.7)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resourcegroup"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
  register: all_resource_groups
  retries: 3
  delay: 2
  until: all_resource_groups.status == 200
  failed_when: all_resource_groups.json.operation.result.status | default('') == 'Failed'
  delegate_to: localhost
  become: false
  when: pam_resource_id is defined

- name: Find Resource Group ID by name
  set_fact:
    pam_resource_group_id: "{{ item.resourceGroupId }}"
  loop: "{{ all_resource_groups.json.operation.Details | default([]) }}"
  when:
    - all_resource_groups is defined
    - all_resource_groups.json is defined
    - item.resourceGroupName == pam_resource_group_name
  no_log: true

- name: Debug resource group ID
  debug:
    msg: "Resource Group '{{ pam_resource_group_name }}' ID: {{ pam_resource_group_id | default('NOT FOUND') }}"

- name: Check if resource is already in group (API 6.4)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/associatedGroups"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
  register: associated_groups
  retries: 3
  delay: 2
  until: associated_groups.status == 200
  failed_when: associated_groups.json.operation.result.status | default('') == 'Failed'
  delegate_to: localhost
  become: false
  when:
    - pam_resource_id is defined
    - pam_resource_group_id is defined

- name: Check if already in target group
  set_fact:
    already_in_group: "{{ pam_resource_group_id in (associated_groups.json.operation.Details['ASSOCIATED GROUPS'] | default([]) | map(attribute='GROUP ID') | map('string') | list) }}"
  when: associated_groups is defined and associated_groups.json is defined

- name: Debug current group associations
  debug:
    msg: "Resource already in '{{ pam_resource_group_name }}': {{ already_in_group | default(false) }}"

- name: Associate Resource to Resource Group (API 6.2)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resourcegroup/{{ pam_resource_group_id }}/associateResources"
    method: POST
    headers:
      AUTHTOKEN: "{{ pam_token }}"
      Content-Type: "text/json"
    validate_certs: "{{ pam_validate_certs }}"
    body: 'INPUT_DATA={"operation":{"Details":{"RESOURCEIDS":[{{ pam_resource_id }}]}}}'
  register: associate_response
  retries: 3
  delay: 2
  until: associate_response.status in [200, 201]
  failed_when: associate_response.json.operation.result.status | default('') == 'Failed'
  delegate_to: localhost
  become: false
  when:
    - pam_resource_id is defined
    - pam_resource_group_id is defined
    - pam_resource_group_id | length > 0
    - not (already_in_group | default(false))

- name: Debug association result
  debug:
    msg: "Association result: {{ associate_response.json.operation.result.message | default('Skipped') }}"
  when: associate_response is defined and associate_response.json is defined

# =======================================================
# 6b. Share Resource Group with User Groups (API 9.10)
# =======================================================
- name: Share Resource Group with User Groups (API 9.10)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resourcegroup/share"
    method: PUT
    headers:
      AUTHTOKEN: "{{ pam_token }}"
      Content-Type: "text/json"
    validate_certs: "{{ pam_validate_certs }}"
    body: 'INPUT_DATA={"operation":{"Details":{"resourceGroupIds":["{{ pam_resource_group_id }}"],"userGroupIds":["{{ item.id }}"],"accessType":"fullaccess"}}}'
  loop: "{{ pam_share_groups | default([]) }}"
  register: share_resource_group_response
  retries: 3
  delay: 2
  until: share_resource_group_response.status in [200, 201] or share_resource_group_response.json.operation.result.status is defined
  failed_when: share_resource_group_response.json.operation.result.status | default('') == 'Failed'
  delegate_to: localhost
  become: false
  when:
    - pam_resource_group_id is defined
    - pam_share_groups | length > 0

- name: Debug resource group sharing results
  debug:
    msg: "Shared resource group '{{ pam_resource_group_name }}' with group '{{ item.item.name }}': {{ item.json.operation.result.message | default('Unknown') }}"
  loop: "{{ share_resource_group_response.results | default([]) }}"
  when:
    - share_resource_group_response is defined
    - share_resource_group_response.results is defined
    - item.json is defined

# =======================================================
# 7. Update Remote Host Passwords (AFTER PAM360 sync)
# =======================================================
- name: Update Remote Linux Users with new passwords
  include_tasks: update_passwords.yml
  loop: "{{ user_pass_map | dict2items }}"
  loop_control:
    loop_var: current_user

# =======================================================
# 8. Generate KeePass-Compatible Password Record (Optional)
# =======================================================
- name: Set timestamp for password file
  set_fact:
    password_file_timestamp: "{{ ansible_facts.date_time.iso8601_basic_short }}"
  delegate_to: localhost
  run_once: true
  when: pam_create_password_file | default(true)

- name: Create password record directory
  file:
    path: "{{ playbook_dir }}/password_records"
    state: directory
    mode: '0700'
  delegate_to: localhost
  become: false
  run_once: true
  when: pam_create_password_file | default(true)

- name: Generate KeePass CSV header (once per run)
  copy:
    content: |
      "Group","Title","Username","Password","URL","Notes"
    dest: "{{ playbook_dir }}/password_records/passwords_{{ password_file_timestamp }}.csv"
    mode: '0600'
  delegate_to: localhost
  become: false
  run_once: true
  when: pam_create_password_file | default(true)

- name: Append password records to CSV
  lineinfile:
    path: "{{ playbook_dir }}/password_records/passwords_{{ password_file_timestamp }}.csv"
    line: '"{{ pam_resource_group_name }}","{{ system_hostname }} - {{ item.key }}","{{ item.key }}","{{ item.value }}","ssh://{{ system_ip }}","Rotated: {{ ansible_facts.date_time.iso8601 }} | Resource ID: {{ pam_resource_id }}"'
    insertafter: EOF
  loop: "{{ user_pass_map | dict2items }}"
  delegate_to: localhost
  become: false
  no_log: true
  when: pam_create_password_file | default(true)

- name: Display password file location
  debug:
    msg: "Password record saved to: {{ playbook_dir }}/password_records/passwords_{{ password_file_timestamp }}.csv"
  run_once: true
  when: pam_create_password_file | default(true)

- name: Display password file skipped
  debug:
    msg: "Password file creation skipped (pam_create_password_file: false)"
  run_once: true
  when: not (pam_create_password_file | default(true))

# =======================================================
# 9. Validate Passwords with PAM360 (API 3.5)
# =======================================================
- name: Initialize password validation results
  set_fact:
    password_validation_results: []

- name: Validate passwords with PAM360 (API 3.5)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/passwords/validate"
    method: POST
    headers:
      AUTHTOKEN: "{{ pam_token }}"
      Content-Type: "text/json"
    validate_certs: "{{ pam_validate_certs }}"
    body: 'INPUT_DATA={"operation":{"details":{"password":"{{ item.value }}","passwordPolicy":"{{ pam_password_policy | default(''Strong'') }}"}}}'
  loop: "{{ user_pass_map | dict2items }}"
  register: password_validations
  retries: 3
  delay: 2
  until: password_validations.status in [200, 201] or password_validations.json.operation.result.status is defined
  delegate_to: localhost
  become: false
  no_log: true

- name: Build password validation results
  set_fact:
    password_validation_results: "{{ password_validation_results + [{'username': item.item.key, 'valid': (item.json.operation.result.message | default('') == 'Valid'), 'status': item.json.operation.result.status | default('Unknown'), 'message': item.json.operation.result.message | default('Unknown')}] }}"
  loop: "{{ password_validations.results | default([]) }}"
  when: item.json is defined
  no_log: true

- name: Debug password validation summary
  debug:
    msg: |
      === PASSWORD VALIDATION RESULTS ===
      Total validated: {{ password_validation_results | length }}
      Valid: {{ password_validation_results | selectattr('valid', 'equalto', true) | list | length }}
      Invalid: {{ password_validation_results | selectattr('valid', 'equalto', false) | list | length }}

# =======================================================
# 10. Fetch Final Account List from PAM360 (API 2.1)
# =======================================================
- name: Get final account list from PAM360 (API 2.1)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/accounts"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
  register: final_accounts
  retries: 3
  delay: 2
  until: final_accounts.status == 200
  failed_when: final_accounts.json.operation.result.status | default('') == 'Failed'
  delegate_to: localhost
  become: false
  when: pam_resource_id is defined

- name: Get individual account details (API 2.2)
  uri:
    url: "{{ pam_url }}/restapi/json/v1/resources/{{ pam_resource_id }}/accounts/{{ item['ACCOUNT ID'] }}"
    method: GET
    headers:
      AUTHTOKEN: "{{ pam_token }}"
    validate_certs: "{{ pam_validate_certs }}"
  loop: "{{ final_accounts.json.operation.Details['ACCOUNT LIST'] | default([]) }}"
  register: account_details
  retries: 3
  delay: 2
  until: account_details.status == 200
  failed_when: account_details.json.operation.result.status | default('') == 'Failed'
  delegate_to: localhost
  become: false
  when: final_accounts is defined and final_accounts.json is defined

# =======================================================
# 11. Discover SSH-Capable Accounts on Remote System
# =======================================================
- name: Get all users with login shells from /etc/passwd
  shell: |
    awk -F: '$7 ~ /(bash|sh|zsh|fish|ksh|csh|tcsh)$/ && $3 >= 1000 {print $1":"$3":"$6":"$7}' /etc/passwd
  register: ssh_users_cmd
  changed_when: false
  failed_when: false

- name: Get system users with login shells (UID < 1000)
  shell: |
    awk -F: '$7 ~ /(bash|sh|zsh|ksh|csh|tcsh)$/ && $3 < 1000 && $1 != "root" {print $1":"$3":"$6":"$7}' /etc/passwd
  register: ssh_system_users_cmd
  changed_when: false
  failed_when: false

- name: Get root account info
  shell: |
    awk -F: '$1 == "root" {print $1":"$3":"$6":"$7}' /etc/passwd
  register: root_user_cmd
  changed_when: false
  failed_when: false

- name: Build discovered SSH accounts list
  set_fact:
    discovered_ssh_accounts: "{{ (root_user_cmd.stdout_lines | default([])) + (ssh_users_cmd.stdout_lines | default([])) + (ssh_system_users_cmd.stdout_lines | default([])) }}"

- name: Parse discovered accounts into structured data
  set_fact:
    discovered_accounts_parsed: "{{ discovered_accounts_parsed | default([]) + [{'username': item.split(':')[0], 'uid': item.split(':')[1], 'home': item.split(':')[2], 'shell': item.split(':')[3]}] }}"
  loop: "{{ discovered_ssh_accounts }}"
  when: item | length > 0

- name: Identify accounts NOT in pam_target_users
  set_fact:
    unmanaged_ssh_accounts: "{{ discovered_accounts_parsed | default([]) | rejectattr('username', 'in', pam_target_users) | list }}"

- name: Debug discovered SSH accounts
  debug:
    msg: |
      === SSH-CAPABLE ACCOUNTS DISCOVERED ===
      Total SSH accounts: {{ discovered_accounts_parsed | default([]) | length }}
      Managed by PAM360: {{ pam_target_users | length }}
      Unmanaged accounts: {{ unmanaged_ssh_accounts | default([]) | length }}

- name: Create SSH accounts report directory
  file:
    path: "{{ playbook_dir }}/ssh_accounts_reports"
    state: directory
    mode: '0700'
  delegate_to: localhost
  become: false
  run_once: true

- name: Generate SSH accounts report file for this host
  copy:
    content: |
      # SSH-Capable Accounts Report
      # Host: {{ system_hostname }} ({{ system_ip }})
      # Generated: {{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}
      # ============================================================
      
      ## ALL SSH-CAPABLE ACCOUNTS
      {% for acc in discovered_accounts_parsed | default([]) %}
      {{ acc.username }}:{{ acc.uid }}:{{ acc.home }}:{{ acc.shell }}{% if acc.username in pam_target_users %} [MANAGED]{% else %} [UNMANAGED]{% endif %}
      
      {% endfor %}
      
      ## UNMANAGED ACCOUNTS (add to pam_target_users if needed)
      {% for acc in unmanaged_ssh_accounts | default([]) %}
      {{ acc.username }}
      {% endfor %}
      
      ## CURRENTLY MANAGED ACCOUNTS
      {% for user in pam_target_users %}
      {{ user }}
      {% endfor %}
    dest: "{{ playbook_dir }}/ssh_accounts_reports/{{ system_hostname }}_ssh_accounts.txt"
    mode: '0600'
  delegate_to: localhost
  become: false

- name: Display SSH accounts report location
  debug:
    msg: "SSH accounts report saved to: {{ playbook_dir }}/ssh_accounts_reports/{{ system_hostname }}_ssh_accounts.txt"

# =======================================================
# 12. Print Summary Report
# =======================================================
- name: Print execution summary
  debug:
    msg: |
      ╔══════════════════════════════════════════════════════════════════════════════╗
      ║                    PAM360 SYNC SUMMARY - {{ system_hostname }}
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ RESOURCE INFO                                                                 
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ Resource ID:    {{ pam_resource_id }}
      ║ Resource Group: {{ pam_resource_group_name }} (ID: {{ pam_resource_group_id | default('N/A') }})
      ║ Host IP:        {{ system_ip }}
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ ACCOUNT STATUS TABLE                                                          
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ USERNAME        │ ACCOUNT ID      │ PAM360 STATUS  │ LINUX STATUS │ POLICY   
      ╠─────────────────┼─────────────────┼────────────────┼──────────────┼──────────╣
      {% for acc in final_accounts.json.operation.Details['ACCOUNT LIST'] | default([]) %}
      ║ {{ "%-15s" | format(acc['ACCOUNT NAME']) }} │ {{ "%-15s" | format(acc['ACCOUNT ID']) }} │ {{ "%-14s" | format('CREATED' if user_status[acc['ACCOUNT NAME']].created_in_pam | default(false) else ('UPDATED' if user_status[acc['ACCOUNT NAME']].updated_pam | default(false) else ('FAILED' if user_status[acc['ACCOUNT NAME']].api_failed | default(false) else 'SYNCED'))) }} │ {{ "%-12s" | format('ROTATED' if user_status[acc['ACCOUNT NAME']].rotated_linux | default(false) else ('SKIPPED' if user_status[acc['ACCOUNT NAME']].skipped_missing_local | default(false) else 'OK')) }} │ {{ acc['ACCOUNT PASSWORD POLICY'] | default('N/A') }}
      {% endfor %}
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ PASSWORD VALIDATION TABLE (API 3.5)                                           
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ USERNAME        │ VALIDATION      │ STATUS         │ MESSAGE                  
      ╠─────────────────┼─────────────────┼────────────────┼──────────────────────────╣
      {% for val in password_validation_results | default([]) %}
      ║ {{ "%-15s" | format(val.username) }} │ {{ "%-15s" | format('VALID' if val.valid else 'INVALID') }} │ {{ "%-14s" | format(val.status) }} │ {{ val.message }}
      {% endfor %}
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ VALIDATION SUMMARY                                                            
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ Total Passwords:  {{ password_validation_results | length }}
      ║ Valid:            {{ password_validation_results | selectattr('valid', 'equalto', true) | list | length }}
      ║ Invalid:          {{ password_validation_results | selectattr('valid', 'equalto', false) | list | length }}
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ ACCOUNT DETAILS (for Audit Trail Correlation)                                 
      ╠══════════════════════════════════════════════════════════════════════════════╣
      {% for result in account_details.results | default([]) %}
      {% if result.json is defined and result.json.operation is defined %}
      ║ {{ result.item['ACCOUNT NAME'] }} (ID: {{ result.item['ACCOUNT ID'] }}):
      ║   Last Modified: {{ result.json.operation.Details['LAST MODIFIED TIME'] | default('N/A') }}
      ║   Last Accessed: {{ result.json.operation.Details['LAST ACCESSED TIME'] | default('N/A') }}
      {% endif %}
      {% endfor %}
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ SHARING INFO                                                                  
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ Shared with Groups: {{ pam_share_groups | map(attribute='name') | list | join(', ') | default('None') }}
      ║ Group IDs:          {{ pam_share_groups | map(attribute='id') | list | join(', ') | default('None') }}
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ SSH-CAPABLE ACCOUNTS DISCOVERED                                               
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ USERNAME        │ UID    │ SHELL              │ STATUS                        
      ╠─────────────────┼────────┼────────────────────┼───────────────────────────────╣
      {% for acc in discovered_accounts_parsed | default([]) %}
      ║ {{ "%-15s" | format(acc.username) }} │ {{ "%-6s" | format(acc.uid) }} │ {{ "%-18s" | format(acc.shell | basename) }} │ {{ 'MANAGED' if acc.username in pam_target_users else 'UNMANAGED' }}
      {% endfor %}
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ SSH DISCOVERY SUMMARY                                                         
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ Total SSH accounts:     {{ discovered_accounts_parsed | default([]) | length }}
      ║ Managed by PAM360:      {{ discovered_accounts_parsed | default([]) | selectattr('username', 'in', pam_target_users) | list | length }}
      ║ Unmanaged (action req): {{ unmanaged_ssh_accounts | default([]) | length }}
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ UNMANAGED ACCOUNTS (add to pam_target_users)                                  
      ╠══════════════════════════════════════════════════════════════════════════════╣
      {% for acc in unmanaged_ssh_accounts | default([]) %}
      ║ {{ acc.username }} (UID: {{ acc.uid }}, Shell: {{ acc.shell | basename }})
      {% endfor %}
      {% if unmanaged_ssh_accounts | default([]) | length == 0 %}
      ║ None - all SSH accounts are managed
      {% endif %}
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║ Report saved to: ssh_accounts_reports/{{ system_hostname }}_ssh_accounts.txt
      ╚══════════════════════════════════════════════════════════════════════════════╝
